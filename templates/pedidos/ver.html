{% extends "base.html" %}

{% block title %}Detalle pedido – Sabor de Autor{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="mb-0">Pedido #{{ pedido.id }}</h3>
        <small class="text-muted">
            {{ pedido.fecha_pedido.strftime("%d/%m/%Y %H:%M") }}
            {% if pedido.estado.name == "entregado" %}
                · <span class="badge bg-success">Entregado</span>
            {% else %}
                · <span class="badge bg-warning text-dark">Pendiente</span>
            {% endif %}
        </small>
    </div>
    <div>
        <a href="/pedidos" class="btn btn-outline-secondary btn-sm">
            ← Volver a pedidos
        </a>
    </div>
</div>

<div class="row g-3 mb-3">
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header">Datos del cliente</div>
            <div class="card-body">
                {% if pedido.cliente %}
                    <p class="mb-1"><strong>Nombre:</strong> {{ pedido.cliente.nombre }}</p>
                    <p class="mb-1"><strong>Teléfono:</strong> {{ pedido.cliente.telefono }}</p>
                    <p class="mb-1"><strong>Email:</strong> {{ pedido.cliente.email }}</p>
                    <p class="mb-0"><strong>Ciudad:</strong> {{ pedido.cliente.ciudad }}</p>
                {% else %}
                    <p class="text-muted mb-0">Este pedido no tiene cliente asociado.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header">Información del pedido</div>
            <div class="card-body">
                <p class="mb-1">
                    <strong>Fecha de pedido:</strong>
                    {{ pedido.fecha_pedido.strftime("%d/%m/%Y %H:%M") }}
                </p>
                <p class="mb-1">
                    <strong>Fecha de entrega:</strong>
                    {% if pedido.fecha_entrega %}
                        {{ pedido.fecha_entrega.strftime("%d/%m/%Y") }}
                    {% else %}
                        <span class="text-muted">Sin fecha definida</span>
                    {% endif %}
                </p>
                <p class="mb-1">
                    <strong>Medio de contacto:</strong>
                    {{ pedido.medio_contacto or '-' }}
                </p>
                <p class="mb-2">
                    <strong>Observaciones:</strong><br>
                    {% if pedido.observaciones %}
                        {{ pedido.observaciones|replace('\n', '<br>')|safe }}
                    {% else %}
                        <span class="text-muted">Sin observaciones.</span>
                    {% endif %}
                </p>

                <hr>

                <p class="mb-1">
                    <strong>Subtotal:</strong>
                    $ {{ "%.2f"|format(subtotal|default(0.0)) }}
                </p>
                <p class="mb-1">
                    <strong>Descuento:</strong>
                    {{ "%.2f"|format(descuento_pct|default(0.0)) }} %
                    ( $ {{ "%.2f"|format(descuento_monto|default(0.0)) }} )
                </p>
                <p class="mb-0 fs-5">
                    <strong>Total:</strong>
                    $ {{ "%.2f"|format(total|default(0.0)) }}
                </p>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header">
        Ítems del pedido
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm table-striped table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Producto</th>
                        <th>Descripción</th>
                        <th class="text-end" style="width: 80px;">Cant.</th>
                        <th class="text-end" style="width: 120px;">Precio unit.</th>
                        <th class="text-end" style="width: 120px;">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% if pedido.items and pedido.items|length > 0 %}
                        {% for item in pedido.items %}
                            <tr>
                                <td>
                                    {% if item.producto %}
                                        {{ item.producto.nombre }}
                                    {% else %}
                                        <span class="text-muted">Sin producto</span>
                                    {% endif %}
                                </td>
                                <td>{{ item.descripcion_item or '' }}</td>
                                <td class="text-end">{{ item.cantidad }}</td>
                                <td class="text-end">
                                    $ {{ "%.2f"|format(item.precio_venta_unitario or 0.0) }}
                                </td>
                                <td class="text-end">
                                    $ {{ "%.2f"|format(item.subtotal or 0.0) }}
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-3">
                                No hay ítems cargados en este pedido.
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}
